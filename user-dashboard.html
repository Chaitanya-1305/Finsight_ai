<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FinSight AI</title>
    <link rel="stylesheet" href="assets/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-chart-line brand-icon"></i>
            <span class="brand-text">FinSight AI</span>
        </div>
        <div class="nav-menu">
            <a href="user-dashboard.html" class="nav-link active">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="history.html" class="nav-link">
                <i class="fas fa-history"></i> History
            </a>
            <a href="chatbot.html" class="nav-link">
                <i class="fas fa-robot"></i> AI Assistant
            </a>
            <a href="profile.html" class="nav-link">
                <i class="fas fa-user"></i> Profile
            </a>
            <a href="#" class="nav-link" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
        <div class="user-info">
            <span id="userName">Loading...</span>
            <i class="fas fa-user-circle"></i>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">
                Welcome back, <span id="userGreeting">User</span>!
            </h1>
            <p class="hero-subtitle">
                Upload your financial documents and get AI-powered insights instantly
            </p>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="stats-container">
            <div class="stat-card">
                <i class="fas fa-file-alt stat-icon"></i>
                <div class="stat-info">
                    <h3 id="totalAnalyses">0</h3>
                    <p>Total Analyses</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock stat-icon"></i>
                <div class="stat-info">
                    <h3 id="thisMonth">0</h3>
                    <p>This Month</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle stat-icon"></i>
                <div class="stat-info">
                    <h3 id="completed">0</h3>
                    <p>Completed</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Upload Section -->
    <section class="upload-section">
        <div class="upload-container">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".pdf,.xlsx,.xls,.csv,.jpg,.jpeg,.png" hidden>
                <div class="upload-content">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3>Drag & Drop Your Files Here</h3>
                    <p>Or click to browse files</p>
                    <div class="supported-formats">
                        <span class="format-tag">PDF</span>
                        <span class="format-tag">Excel</span>
                        <span class="format-tag">CSV</span>
                        <span class="format-tag">Images</span>
                    </div>
                </div>
                <div class="file-selected" id="fileSelected" style="display: none;">
                    <i class="fas fa-file-alt"></i>
                    <span id="fileName"></span>
                    <button class="btn-remove" id="removeFile">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <button class="btn-analyze" id="analyzeBtn" style="display: none;">
                <i class="fas fa-brain"></i> Analyze Document
            </button>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section">
        <h2 class="section-title">AI-Powered Features</h2>
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h3>Smart Analysis</h3>
                <p>Advanced ML algorithms analyze your financial data with precision</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>Risk Detection</h3>
                <p>Identify potential risks and compliance issues automatically</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3>Visual Reports</h3>
                <p>Interactive dashboards and comprehensive reporting</p>
            </div>
        </div>
    </section>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="loader"></div>
            <h3>Analyzing Your Document...</h3>
            <p>AI is processing your financial data</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let selectedFile = null;

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Update UI with user info
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userGreeting').textContent = userData.name.split(' ')[0];
                    
                    // Load user stats
                    loadUserStats(user.uid);
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load user statistics
        async function loadUserStats(userId) {
            try {
                const analysesSnapshot = await db.collection('analyses')
                    .where('userId', '==', userId)
                    .get();
                
                const total = analysesSnapshot.size;
                
                // Get this month's count
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const thisMonthSnapshot = await db.collection('analyses')
                    .where('userId', '==', userId)
                    .where('createdAt', '>=', firstDayOfMonth)
                    .get();
                
                const thisMonth = thisMonthSnapshot.size;
                
                // Update UI
                document.getElementById('totalAnalyses').textContent = total;
                document.getElementById('thisMonth').textContent = thisMonth;
                document.getElementById('completed').textContent = total;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await auth.signOut();
                sessionStorage.clear();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileSelected = document.getElementById('fileSelected');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            selectedFile = file;
            fileName.textContent = file.name;
            fileSelected.style.display = 'flex';
            analyzeBtn.style.display = 'block';
            document.querySelector('.upload-content').style.display = 'none';
        }

        document.getElementById('removeFile').addEventListener('click', (e) => {
            e.stopPropagation();
            selectedFile = null;
            fileInput.value = '';
            fileSelected.style.display = 'none';
            analyzeBtn.style.display = 'none';
            document.querySelector('.upload-content').style.display = 'block';
        });

        // Analyze button
        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            if (!selectedFile || !currentUser) return;

            const loadingModal = document.getElementById('loadingModal');
            loadingModal.style.display = 'flex';

            try {
                // Upload file to Firebase Storage
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`uploads/${currentUser.uid}/${Date.now()}_${selectedFile.name}`);
                
                await fileRef.put(selectedFile);
                const downloadURL = await fileRef.getDownloadURL();

                // Save analysis record to Firestore
                const analysisData = {
                    userId: currentUser.uid,
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    fileType: selectedFile.type,
                    fileURL: downloadURL,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // Simulated results (replace with actual ML model integration later)
                    results: {
                        summary: 'Analysis pending - ML model integration required',
                        riskScore: 0,
                        recommendations: []
                    }
                };

                await db.collection('analyses').add(analysisData);

                // Update user's analysis count
                await db.collection('users').doc(currentUser.uid).update({
                    analysisCount: firebase.firestore.FieldValue.increment(1),
                    lastAnalysis: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Simulate processing time
                setTimeout(() => {
                    loadingModal.style.display = 'none';
                    alert('Analysis complete! View results in History page.');
                    
                    // Reset upload area
                    selectedFile = null;
                    fileInput.value = '';
                    fileSelected.style.display = 'none';
                    analyzeBtn.style.display = 'none';
                    document.querySelector('.upload-content').style.display = 'block';
                    
                    // Reload stats
                    loadUserStats(currentUser.uid);
                }, 3000);

            } catch (error) {
                console.error('Error analyzing file:', error);
                loadingModal.style.display = 'none';
                alert('Error analyzing file. Please try again.');
            }
        });
    </script>
</body>
</html>
